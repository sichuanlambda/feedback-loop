<div class="container">
  <h1 class="text-center mb-4">Architecture Style Finder</h1>
  

  <div class="row">
    <div class="col-md-8">
      <div id="image-gallery" class="row">
        <% BuildingAnalysis.where(visible_in_library: true).order("RANDOM()").limit(20).each do |building| %>
          <div class="col-md-4 mb-3">
            <div class="card h-100 building-card">
              <div class="square-image-container">
                <img src="<%= building.image_url %>" class="card-img-top square-image" alt="Building Image" data-toggle="modal" data-target="#imageModal<%= building.id %>">
              </div>
              <div class="card-body d-flex flex-column justify-content-end">
                <button class="btn btn-outline-primary btn-sm select-image w-100" 
                        data-building-id="<%= building.id %>" 
                        data-styles="<%= building.h3_contents.to_json %>"
                        onclick="console.log('Raw h3_contents for building <%= building.id %>:', <%= raw building.h3_contents.to_json %>)">
                  Select
                </button>
              </div>
            </div>
          </div>

          <!-- Modal for each image -->
          <div class="modal fade" id="imageModal<%= building.id %>" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel<%= building.id %>" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="imageModalLabel<%= building.id %>">Building Details</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <img src="<%= building.image_url %>" class="img-fluid mb-3" alt="Building Image">
                  <h6>Architectural Styles:</h6>
                  <ul>
                    <% JSON.parse(building.h3_contents || '[]').each do |style| %>
                      <li><%= style %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-body">
          <h5 class="card-title">Your Style Preferences</h5>
          <div id="selected-styles"></div>
          <button id="analyze-button" class="btn btn-primary btn-block mt-3">Analyze My Style</button>
          <%# <div id="loading-spinner" class="text-center mt-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Generating your custom building...</p>
          </div>
          <div id="generated-image" class="mt-3"></div>
          <button id="generate-new-image" class="btn btn-secondary btn-block mt-3" style="display: none;">Generate New Image</button> %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .square-image-container {
    position: relative;
    width: 100%;
    padding-top: 100%; /* 1:1 Aspect Ratio */
    overflow: hidden;
  }
  .square-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  .square-image:hover {
    transform: scale(1.05);
  }
  .building-card {
    transition: box-shadow 0.3s ease;
  }
  .building-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  #selected-styles {
    background-color: #f0f0f0;
    padding: 10px;
    margin-top: 10px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded');
    const selectedBuildings = new Map();
    const selectButtons = document.querySelectorAll('.select-image');
    const analyzeButton = document.getElementById('analyze-button');
    const selectedStylesDiv = document.getElementById('selected-styles');
    const generatedImageDiv = document.getElementById('generated-image');
    const generateNewImageButton = document.getElementById('generate-new-image');
    
    console.log('Analyze button found:', analyzeButton);
    console.log('Selected styles div found:', selectedStylesDiv);

    if (analyzeButton) {
      analyzeButton.addEventListener('click', function() {
        console.log('Analyze button clicked');
        if (!selectedBuildings || selectedBuildings.size === 0) {
          console.error('No buildings selected');
          alert('Please select at least one building before analyzing.');
          return;
        }
        analyzeMyStyle();
      });
    } else {
      console.error('Analyze button not found!');
    }

    if (generateNewImageButton) {
      generateNewImageButton.addEventListener('click', function() {
        console.log('Generate New Image button clicked');
        generateImage(window.preferredStyles);
      });
    } else {
      console.error('Generate New Image button not found!');
    }

    selectButtons.forEach(button => {
      button.addEventListener('click', function() {
        const buildingId = this.getAttribute('data-building-id');
        const stylesData = this.getAttribute('data-styles');
        console.log(`Raw styles data for building ${buildingId}:`, stylesData);
        
        let parsedStyles;
        try {
          parsedStyles = JSON.parse(stylesData || '[]');
          if (!Array.isArray(parsedStyles)) {
            console.warn(`Parsed styles for building ${buildingId} is not an array, converting to array.`);
            parsedStyles = [parsedStyles].filter(Boolean);
          }
        } catch (error) {
          console.error(`Error parsing styles for building ${buildingId}:`, error);
          parsedStyles = [];
        }
        
        console.log(`Parsed styles for building ${buildingId}:`, parsedStyles);
        
        if (selectedBuildings.has(buildingId)) {
          selectedBuildings.delete(buildingId);
          this.classList.remove('btn-primary');
          this.classList.add('btn-outline-primary');
          this.textContent = 'Select';
        } else {
          selectedBuildings.set(buildingId, parsedStyles);
          this.classList.remove('btn-outline-primary');
          this.classList.add('btn-primary');
          this.textContent = 'Selected';
        }
        
        console.log('Updated selected buildings:', Array.from(selectedBuildings.entries()));
        
        analyzeButton.disabled = selectedBuildings.size === 0;
        updateSelectedCount();
      });
    });
    
function analyzeMyStyle() {
  console.log('analyzeMyStyle function called');
  console.log('Selected buildings:', Array.from(selectedBuildings.entries()));

  if (selectedBuildings.size === 0) {
    alert('Please select at least one building before analyzing.');
    return;
  }

  const allStyles = {};
  let totalCount = 0;
  let hasPercentages = false;

  selectedBuildings.forEach((parsedStyles, buildingId) => {
    console.log(`Processing building ${buildingId}, styles:`, parsedStyles);

    if (!Array.isArray(parsedStyles)) {
      console.warn(`Styles for building ${buildingId} is not an array:`, parsedStyles);
      return;
    }

    parsedStyles.forEach((style) => {
      if (typeof style !== 'string') {
        console.warn(`Invalid style for building ${buildingId}:`, style);
        return;
      }

      // Check if the style is a JSON string and parse it
      if (style.startsWith('[') && style.endsWith(']')) {
        try {
          const jsonStyles = JSON.parse(style);
          jsonStyles.forEach(processStyle);
        } catch (error) {
          console.error(`Error parsing JSON style: ${style}`, error);
        }
      } else {
        processStyle(style);
      }
    });
  });

  function processStyle(style) {
    console.log(`Processing style: "${style}"`);
    const trimmedStyle = style.trim();
    const match = trimmedStyle.match(/(.+?)(?::\s*(\d+(?:\.\d+)?)%?)?$/);

    if (match) {
      const styleName = match[1].trim();
      const percentage = match[2] ? parseFloat(match[2]) : 100; // Default to 100 if no percentage

      if (!isNaN(percentage)) {
        if (match[2]) hasPercentages = true;
        allStyles[styleName] = (allStyles[styleName] || 0) + percentage;
        totalCount += percentage;
        console.log(`Added style: "${styleName}", Percentage: ${percentage}, Total count: ${totalCount}`);
      } else {
        console.warn(`Invalid percentage for style: "${trimmedStyle}"`);
      }
    } else {
      console.warn(`Style didn't match expected format: "${trimmedStyle}"`);
    }
  }

  console.log('Processed styles:', allStyles);
  console.log('Total count:', totalCount);
  console.log('Has percentages:', hasPercentages);

  if (totalCount === 0) {
    alert('No valid architectural styles found in the selected buildings.');
    return;
  }

  const preferredStyles = Object.entries(allStyles)
    .map(([name, count]) => ({
      name,
      percentage: Math.round((count / totalCount) * 100)
    }))
    .sort((a, b) => b.percentage - a.percentage);

  console.log('Preferred styles:', preferredStyles);
  window.preferredStyles = preferredStyles;
  displayPreferredStyles(preferredStyles);
  generateImage(preferredStyles);
  generateNewImageButton.style.display = 'block';
}

function displayPreferredStyles(styles) {
  console.log('displayPreferredStyles called with styles:', styles);
  
  if (!selectedStylesDiv) {
    console.error('selected-styles div not found');
    return;
  }
  
  selectedStylesDiv.innerHTML = '<h6 class="mb-3">Your Top Styles:</h6>';
  styles.slice(0, 5).forEach(style => {
    const styleElement = document.createElement('div');
    styleElement.className = 'mb-2';
    styleElement.innerHTML = `
      <span>${style.name}</span>
      <div class="progress">
        <div class="progress-bar" role="progressbar" style="width: ${style.percentage}%;" 
             aria-valuenow="${style.percentage}" aria-valuemin="0" aria-valuemax="100">${style.percentage}%</div>
      </div>
    `;
    selectedStylesDiv.appendChild(styleElement);
  });

  console.log('UI updated with preferred styles');
}

function generateImage(styles) {
  console.log('Generating image based on styles:', styles);
  
  // Show loading spinner
  document.getElementById('loading-spinner').style.display = 'block';
  
  // Prepare the prompt for image generation
  const prompt = styles.slice(0, 3).map(style => style.name).join(', ');
  
  // Make an AJAX call to the ArchitectureDesignerController to generate the image
  fetch('/architecture_designer/submit', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
    },
    body: JSON.stringify({ 
      architecture_type: prompt,
      step2_selections: window.preferredStyles
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    // Hide loading spinner
    document.getElementById('loading-spinner').style.display = 'none';
    
    if (data.image_url) {
      displayGeneratedImage(data.image_url);
    } else {
      console.error('Failed to generate image:', data);
      alert('Failed to generate image. Please try again.');
    }
  })
  .catch(error => {
    console.error('Error generating image:', error);
    // Hide loading spinner
    document.getElementById('loading-spinner').style.display = 'none';
    alert('An error occurred while generating the image. Please try again.');
  });
}

function displayGeneratedImage(imageUrl) {
  const generatedImageDiv = document.getElementById('generated-image');
  if (!generatedImageDiv) {
    console.error('generated-image div not found');
    return;
  }
  
  generatedImageDiv.innerHTML = `
    <h6 class="mb-3">Generated Building Based on Your Style:</h6>
    <img src="${imageUrl}" class="img-fluid" alt="Generated Building">
  `;
  
  // Show the "Generate New Image" button
  const generateNewImageButton = document.getElementById('generate-new-image');
  if (generateNewImageButton) {
    generateNewImageButton.style.display = 'block';
  }
}

function updateSelectedCount() {
  const count = selectedBuildings.size;
  analyzeButton.textContent = `Analyze My Style (${count} selected)`;
  console.log('Selected count updated:', count);
}

console.log('Event listeners set up');
  });
</script>
