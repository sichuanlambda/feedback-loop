<% content_for :title, "City Architecture Guides ‚Äî Explore #{@places.count} Cities Worldwide" %>
<% content_for :meta_description, "Explore architecture guides for #{@places.count} cities worldwide. #{@places.sum { |p| p.building_analyses_in_place.count }} buildings analyzed with style breakdowns, history, and walking tours." %>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-M4TLZ8N6CC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-M4TLZ8N6CC');
</script>

<!-- Plausible Analytics -->
<script defer data-domain="app.architecturehelper.com" src="https://plausible.io/js/script.js"></script>

<%
  total_buildings = @places.sum { |p| p.building_analyses_in_place.count }
  all_styles = Hash.new(0)
  @places.each do |p|
    p.architectural_styles_summary.first(3).each { |s, _| all_styles[s.gsub(/\s*\d+%$/, '')] += 1 }
  end
  top_styles = all_styles.sort_by { |_, v| -v }.first(5).map(&:first)
  
  # Group by region
  us_cities = @places.select { |p| %w[denver-colorado san-francisco chicago new-orleans new-york-city washington-dc philadelphia boston].include?(p.slug) }
  eu_cities = @places.select { |p| %w[barcelona edinburgh bruges krakow den-haag].include?(p.slug) }
  other_cities = @places - us_cities - eu_cities
  
  # Sort each group by building count desc
  us_cities = us_cities.sort_by { |p| -p.building_analyses_in_place.count }
  eu_cities = eu_cities.sort_by { |p| -p.building_analyses_in_place.count }
  
  # Featured = top 2 by building count overall
  sorted_all = @places.sort_by { |p| -p.building_analyses_in_place.count }
  featured = sorted_all.first(2)
%>

<div class="places-index">
  <!-- Hero -->
  <div class="hero-section">
    <div class="hero-overlay"></div>
    <div class="container hero-content">
      <div class="hero-label">CITY ARCHITECTURE GUIDES</div>
      <h1>Explore Architecture Around the World</h1>
      <p class="hero-subtitle">In-depth guides to notable buildings, architectural styles, and design history</p>
      <div class="hero-stats">
        <div class="hero-stat">
          <span class="hero-stat-value"><%= @places.count %></span>
          <span class="hero-stat-label">Cities</span>
        </div>
        <div class="hero-stat-divider"></div>
        <div class="hero-stat">
          <span class="hero-stat-value"><%= total_buildings %></span>
          <span class="hero-stat-label">Buildings Analyzed</span>
        </div>
        <div class="hero-stat-divider"></div>
        <div class="hero-stat">
          <span class="hero-stat-value"><%= all_styles.size %></span>
          <span class="hero-stat-label">Architectural Styles</span>
        </div>
      </div>
      <div class="hero-styles">
        <% top_styles.each do |style| %>
          <span class="hero-style-tag"><%= style %></span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Search & Filter Bar -->
  <div class="filter-bar">
    <div class="container filter-bar-inner">
      <div class="search-box">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" id="city-search" placeholder="Search cities..." autocomplete="off">
      </div>
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">All Cities</button>
        <button class="filter-tab" data-filter="us">United States</button>
        <button class="filter-tab" data-filter="europe">Europe</button>
      </div>
      <div class="sort-select">
        <select id="city-sort">
          <option value="buildings">Most Buildings</option>
          <option value="name">A-Z</option>
          <option value="newest">Recently Added</option>
        </select>
      </div>
    </div>
  </div>

  <% if @places.any? %>
    <div class="places-content">
      <div class="container">
        
        <!-- Featured Cities -->
        <% if featured.any? %>
        <div class="section-header">
          <h2>Featured Guides</h2>
          <p>Our most comprehensive city architecture guides</p>
        </div>
        <div class="featured-grid">
          <% featured.each do |place| %>
            <% building_count = place.building_analyses_in_place.count %>
            <% styles = place.architectural_styles_summary.first(3) %>
            <%= link_to place_path(place), class: "featured-card", data: { region: us_cities.include?(place) ? 'us' : 'europe', name: place.name.downcase, buildings: building_count } do %>
              <div class="featured-image">
                <% if place.best_representative_image.present? %>
                  <img src="<%= place.best_representative_image %>" alt="<%= place.name %> architecture" loading="lazy">
                <% end %>
                <div class="featured-image-overlay"></div>
                <div class="featured-content">
                  <span class="featured-badge-label">Featured Guide</span>
                  <h3><%= place.name %></h3>
                  <div class="featured-meta">
                    <span><%= building_count %> buildings</span>
                    <% if styles.any? %>
                      <span class="meta-sep">&middot;</span>
                      <span><%= styles.first(3).map { |s, _| s.gsub(/\s*\d+%$/, '') }.join(', ') %></span>
                    <% end %>
                  </div>
                  <% if place.description.present? %>
                    <p class="featured-desc"><%= truncate(place.description, length: 160) %></p>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
        <% end %>

        <!-- United States -->
        <% us_remaining = us_cities - featured %>
        <% if us_remaining.any? %>
        <div class="section-header region-section" data-region="us">
          <h2>üá∫üá∏ United States</h2>
          <p><%= us_cities.count %> cities, <%= us_cities.sum { |p| p.building_analyses_in_place.count } %> buildings</p>
        </div>
        <div class="places-grid" data-region="us">
          <% us_remaining.each do |place| %>
            <%= render partial: 'place_card', locals: { place: place, region: 'us' } %>
          <% end %>
        </div>
        <% end %>

        <!-- Europe -->
        <% eu_remaining = eu_cities - featured %>
        <% if eu_remaining.any? %>
        <div class="section-header region-section" data-region="europe">
          <h2>üá™üá∫ Europe</h2>
          <p><%= eu_cities.count %> cities, <%= eu_cities.sum { |p| p.building_analyses_in_place.count } %> buildings</p>
        </div>
        <div class="places-grid" data-region="europe">
          <% eu_remaining.each do |place| %>
            <%= render partial: 'place_card', locals: { place: place, region: 'europe' } %>
          <% end %>
        </div>
        <% end %>

        <!-- Other -->
        <% if other_cities.any? %>
        <div class="section-header region-section" data-region="other">
          <h2>üåç More Cities</h2>
        </div>
        <div class="places-grid" data-region="other">
          <% other_cities.each do |place| %>
            <%= render partial: 'place_card', locals: { place: place, region: 'other' } %>
          <% end %>
        </div>
        <% end %>

      </div>
    </div>

    <!-- CTA -->
    <div class="cta-section">
      <div class="container cta-inner">
        <h2>More cities coming soon</h2>
        <p>We're adding new city guides regularly. Next up: Detroit, Savannah, Los Angeles, Istanbul, and more.</p>
        <div class="cta-upcoming">
          <% %w[Detroit Savannah Istanbul Rome Tirana Miami Charleston Pittsburgh Nashville].each do |city| %>
            <span class="upcoming-tag"><%= city %></span>
          <% end %>
        </div>
      </div>
    </div>

  <% else %>
    <div class="no-places">
      <h2>No Places Available Yet</h2>
      <p>We're working on creating architecture guides for cities and regions around the world.</p>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Search
  const searchInput = document.getElementById('city-search');
  const allCards = document.querySelectorAll('.featured-card, .place-card');
  const sections = document.querySelectorAll('.section-header, .places-grid, .featured-grid');
  
  searchInput.addEventListener('input', function() {
    const q = this.value.toLowerCase().trim();
    allCards.forEach(card => {
      const name = (card.dataset.name || card.querySelector('h3')?.textContent || '').toLowerCase();
      card.style.display = name.includes(q) || q === '' ? '' : 'none';
    });
  });
  
  // Filter tabs
  const tabs = document.querySelectorAll('.filter-tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      tabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      const filter = this.dataset.filter;
      
      document.querySelectorAll('.region-section, .places-grid[data-region]').forEach(el => {
        if (filter === 'all') {
          el.style.display = '';
        } else {
          el.style.display = el.dataset.region === filter ? '' : 'none';
        }
      });
      
      // Featured always shows
      document.querySelectorAll('.featured-grid, .featured-grid + .section-header').forEach(el => {
        el.style.display = filter === 'all' ? '' : 'none';
      });
      
      if (filter !== 'all') {
        // Show featured cards matching filter
        document.querySelectorAll('.featured-card').forEach(card => {
          card.style.display = card.dataset.region === filter ? '' : 'none';
        });
      }
    });
  });
  
  // Sort
  const sortSelect = document.getElementById('city-sort');
  sortSelect.addEventListener('change', function() {
    document.querySelectorAll('.places-grid').forEach(grid => {
      const cards = Array.from(grid.children);
      cards.sort((a, b) => {
        if (this.value === 'buildings') return (parseInt(b.dataset.buildings) || 0) - (parseInt(a.dataset.buildings) || 0);
        if (this.value === 'name') return (a.dataset.name || '').localeCompare(b.dataset.name || '');
        return 0; // newest = default order
      });
      cards.forEach(card => grid.appendChild(card));
    });
  });
});
</script>

<style>
.places-index {
  min-height: 100vh;
  background-color: #fafafa;
}

/* Hero */
.hero-section {
  position: relative;
  color: white;
  padding: 80px 0 60px;
  text-align: center;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  overflow: hidden;
}
.hero-section::before {
  content: '';
  position: absolute;
  inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
}
.hero-content { position: relative; z-index: 2; }
.hero-label {
  font-size: 12px; font-weight: 700; letter-spacing: 3px;
  color: rgba(255,255,255,0.6); margin-bottom: 16px;
}
.hero-section h1 {
  font-size: 3rem; font-weight: 800; margin: 0 0 12px;
  letter-spacing: -0.5px;
}
.hero-subtitle {
  font-size: 1.15rem; color: rgba(255,255,255,0.7);
  max-width: 600px; margin: 0 auto 32px;
}
.hero-stats {
  display: flex; justify-content: center; align-items: center; gap: 0;
  margin-bottom: 24px;
}
.hero-stat { padding: 0 32px; text-align: center; }
.hero-stat-value { display: block; font-size: 2.2rem; font-weight: 800; color: white; }
.hero-stat-label { font-size: 0.85rem; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
.hero-stat-divider { width: 1px; height: 40px; background: rgba(255,255,255,0.15); }
.hero-styles { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
.hero-style-tag {
  background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
  padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; color: rgba(255,255,255,0.8);
}

/* Filter Bar */
.filter-bar {
  background: white; border-bottom: 1px solid #e5e7eb;
  padding: 16px 0; position: sticky; top: 0; z-index: 100;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.filter-bar-inner { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
.search-box {
  display: flex; align-items: center; gap: 8px;
  background: #f3f4f6; border-radius: 10px; padding: 10px 16px; flex: 1; min-width: 200px;
}
.search-box input {
  border: none; background: none; outline: none; font-size: 0.95rem; width: 100%; color: #1f2937;
}
.filter-tabs { display: flex; gap: 4px; }
.filter-tab {
  padding: 8px 18px; border-radius: 8px; border: 1px solid #e5e7eb;
  background: white; font-size: 0.85rem; font-weight: 600; color: #6b7280;
  cursor: pointer; transition: all 0.2s;
}
.filter-tab:hover { border-color: #0056b3; color: #0056b3; }
.filter-tab.active { background: #0056b3; color: white; border-color: #0056b3; }
.sort-select select {
  padding: 10px 16px; border-radius: 10px; border: 1px solid #e5e7eb;
  font-size: 0.85rem; color: #374151; background: white; cursor: pointer;
}

/* Sections */
.places-content { padding: 40px 0 60px; }
.section-header { margin: 40px 0 20px; }
.section-header:first-child { margin-top: 0; }
.section-header h2 { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0 0 4px; }
.section-header p { font-size: 0.9rem; color: #6b7280; margin: 0; }

/* Featured Grid */
.featured-grid {
  display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;
}
.featured-card {
  display: block; border-radius: 16px; overflow: hidden;
  text-decoration: none; color: inherit;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  transition: transform 0.3s, box-shadow 0.3s;
}
.featured-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(0,0,0,0.15);
  text-decoration: none; color: inherit;
}
.featured-image {
  position: relative; height: 300px; overflow: hidden;
}
.featured-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
.featured-card:hover .featured-image img { transform: scale(1.03); }
.featured-image-overlay {
  position: absolute; inset: 0;
  background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 40%, transparent 100%);
}
.featured-content {
  position: absolute; bottom: 0; left: 0; right: 0; padding: 28px; color: white;
}
.featured-badge-label {
  display: inline-block; background: rgba(255,255,255,0.2);
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  border: 1px solid rgba(255,255,255,0.2);
  padding: 4px 12px; border-radius: 20px; font-size: 0.7rem;
  font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px;
}
.featured-content h3 { font-size: 1.8rem; font-weight: 800; margin: 0 0 8px; color: white; }
.featured-meta { font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 8px; }
.meta-sep { margin: 0 8px; }
.featured-desc { font-size: 0.85rem; color: rgba(255,255,255,0.65); margin: 0; line-height: 1.5; }

/* City Card Grid */
.places-grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
}
.place-card {
  display: block; background: white; border-radius: 14px; overflow: hidden;
  text-decoration: none; color: inherit;
  box-shadow: 0 1px 4px rgba(0,0,0,0.06);
  transition: transform 0.25s, box-shadow 0.25s;
  border: 1px solid #f0f0f0;
}
.place-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.1);
  text-decoration: none; color: inherit;
}
.place-card-image { position: relative; height: 180px; overflow: hidden; }
.place-card-image img, .place-card .card-image {
  width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s;
}
.place-card:hover .card-image, .place-card:hover .place-card-image img { transform: scale(1.05); }
.image-overlay {
  position: absolute; bottom: 0; left: 0; right: 0; height: 40%;
  background: linear-gradient(transparent, rgba(0,0,0,0.2));
}
.place-card-badge {
  position: absolute; top: 12px; right: 12px;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  color: white; font-size: 0.8rem; font-weight: 700; padding: 4px 10px; border-radius: 8px;
}
.place-card-content { padding: 20px; }
.place-card-content h3 {
  margin: 0 0 8px; font-size: 1.2rem; font-weight: 700; color: #1f2937;
}
.place-card-styles {
  display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px;
}
.style-pill {
  font-size: 0.75rem; font-weight: 600; color: #4b5563;
  background: #f3f4f6; padding: 3px 10px; border-radius: 6px;
}
.place-card-desc {
  font-size: 0.88rem; color: #6b7280; line-height: 1.6; margin-bottom: 14px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.place-card-footer {
  display: flex; justify-content: space-between; align-items: center;
  padding-top: 12px; border-top: 1px solid #f3f4f6;
}
.place-card-footer .building-count { font-size: 0.85rem; font-weight: 600; color: #0056b3; }
.place-card-footer .explore-link {
  font-size: 0.85rem; font-weight: 600; color: #0056b3;
  display: flex; align-items: center; gap: 4px; transition: gap 0.2s;
}
.place-card:hover .explore-link { gap: 8px; }

/* CTA Section */
.cta-section {
  background: #1a1a2e; color: white; padding: 60px 0; text-align: center;
}
.cta-inner h2 { font-size: 1.8rem; font-weight: 700; margin: 0 0 8px; }
.cta-inner p { color: rgba(255,255,255,0.6); font-size: 1rem; margin: 0 0 24px; }
.cta-upcoming { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }
.upcoming-tag {
  background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
  padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; color: rgba(255,255,255,0.5);
}

/* Container */
.container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

/* Responsive */
@media (max-width: 1024px) {
  .places-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 768px) {
  .hero-section { padding: 60px 0 40px; }
  .hero-section h1 { font-size: 2.2rem; }
  .hero-stats { gap: 0; }
  .hero-stat { padding: 0 16px; }
  .hero-stat-value { font-size: 1.6rem; }
  .featured-grid { grid-template-columns: 1fr; }
  .featured-image { height: 220px; }
  .featured-content h3 { font-size: 1.4rem; }
  .places-grid { grid-template-columns: 1fr; }
  .filter-bar-inner { flex-direction: column; align-items: stretch; }
  .filter-tabs { overflow-x: auto; white-space: nowrap; }
  .cta-inner h2 { font-size: 1.4rem; }
}
</style>
